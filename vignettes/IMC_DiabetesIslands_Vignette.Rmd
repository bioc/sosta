---
title: "Reconstrucion and analysis of diabetes island from IMC data"
author: 
  - name: "Samuel Gunz"
    affiliation:
      - &DMLS Department of Molecular Life Sciences, University of Zurich, Switzerland
      - &SIB SIB Swiss Institute of Bioinformatics, University of Zurich, Switzerland
    email: "samuel.gunz@uzh.ch"
  - name: Mark D. Robinson
    affiliation:
      - *DMLS
      - *SIB
package: "`r BiocStyle::Biocpkg('sosta')`"
output:
  BiocStyle::html_document
abstract: >
  Reconstrucion and analysis of diabetes island from IMC data using the `sosta` package
vignette: >
  %\VignetteIndexEntry{Reconstrucion and analysis of diabetes island from IMC data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}  
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Setup

```{r setup, message=FALSE}
library("sosta")
library("dplyr")
library("ggplot2")
library("patchwork")
library("ggspavis")
library("spatstat.explore")
library("spatstat.geom")
library("imcdatasets")
```


# Introduction

In this vignette we will use data from the package `r BiocStyle::Biocpkg('imcdatasets')`. The dataset contains imaging mass cytometry (IMC) data of pancreatic islets human donors at different stages of type 1 diabetes (T1D) [@damondMapHumanType2019]. 

From the manual of `r BiocStyle::Biocpkg('imcdatasets')` and the original publication by @damondMapHumanType2019 we know that

>The three donors in the subset present the following characteristics:
>
> 6126 is a non-diabetic donor, with large islets containing many beta cells, severe infiltration of the exocrine pancreas with myeloid cells but limited infiltration of islets.
>
> 6414 is a donor with recent T1D onset (shortly after diagnosis) showing partial beta cell destruction and mild infiltration of islets with T cells.
> 6180 is a donor with long-duration T1D (11 years after diagnosis), showing near-total beta cell destruction and limited immune cell infiltration in both the islets and the pancreas.


```{r loading}
# load the data
spe <- imcdatasets::Damond_2019_Pancreas("spe", full_dataset = FALSE)
spe
``` 

First we plot the data for illustration. As we have multiple images per patient we will subset one patient and a few slides.


```{r}
plotSpots(spe[,spe[["patient_id"]] == 6126 &
                spe[["image_name"]] %in% c("E02", "E03", "E04")],
          annotate = "cell_category",
          sample_id = "image_name",
          in_tissue = NULL) +
  facet_wrap(~ image_name)
```
# Reconstruction of diabetes islets

## Reconstruction of diabetes islets for one image

In this example we will reconstruct the density based on the point pattern density of the islet cells. For this we use functions from the package `r BiocStyle::CRANpkg('spatstat')` which is a convenient package for point pattern analysis. We show the workflow for one image, before continuing to all do it for all images.

First we will create a `ppp` object using `SPE2ppp`

```{r}
# Convert the spe object to a point pattern object
pp <- SPE2ppp(spe, marks = "cell_category", image_col = "image_name", image_id = "E04")

# Extract the islet cells
pp.islet <- subset(pp, marks == "islet")
```

Next we will set the default dimension for the resulting image. A lower resolution speed up computation but lead to less exact reconstruction. We set a default of 500 pixels for the x dimension, the corresponding y dimension gets directly calculated.

```{r}
# Set the dimensions of the resulting reconstruction
dimyx <- getDimXY(pp.islet, 500)
```

To select the threshold for the reconstruction we look at the density of one image. The function `bw.diggle` estimates the bandwith for the smoothing kernel. The result is a image (m x n matrix with density values).

```{r}
# plot the density of the image
im <- density(pp.islet, sigma = bw.diggle(pp.islet), dimyx = dimyx)

par(mfrow = c(1, 2))
plot(im)
hist(im)
```

From the histogram and the density image we can see that there are a lot of pixels with 0 density. To set the threshold at 0.0025 to include as many cells as possible in the estimation of the islets. We then use the function `reconstructShapeDensity` to reconstruct the image. The result is a `r BiocStyle::CRANpkg('sf')` polygon.


## Reconstruction of diabetes islets for one image

In this example we will reconstruct the density based on the point pattern density of the islet cells. We will start with a few images to set the necessary parameters.


```{r, eval=FALSE}
n <- estimateReconstructionParametersSPE(
  spe,
  marks = "cell_category",
  image_col = "image_name",
  mark_select = "islet",
  ncores = 5,
  plot_hist = TRUE
)

thres <- mean(n$thres)
bndw <- mean(n$bndw)

```

```{r, eval=FALSE}
colData(spe)$image_name |> unique()


shapeIntensityImage(
  spe,
  marks = "cell_category",
  image_col = "image_name",
  image_id = "J13",
  bndw = bndw,
  mark_select = "islet"
)


p2 <- reconstructShapeDensityImage(
  spe,
  marks = "cell_category",
  image_col = "image_name",
  image_id = "J13",
  mark_select = "islet"
)

spe_sel <- spe[, spe[["image_name"]] %in% c("J13")]
spe_sel_df <- cbind(spatialCoords(spe_sel), colData(spe_sel))

ggplot() +
  geom_point(data = spe_sel_df,
             aes(x = cell_x, y = cell_y, color = cell_category), size = 0.75) +
  theme_light() +
  #scale_color_brewer(palette = "Set1") +
  geom_sf(data = p2, fill = NA, color = "black")
```


```{r, eval=FALSE}
shapeIntensityImage(
  spe,
  marks = "cell_category",
  image_col = "image_name",
  image_id = "E04",
  bndw = bndw,
  mark_select = "islet"
)

```

From the histogram and the density image we can see that there are a lot of pixels with 0 density. To set the threshold at 0.004. We then use the function `reconstructShapeDensity` to reconstruct the image. The result is a `r BiocStyle::CRANpkg('sf')` polygon. 


```{r, eval=FALSE}
islet <- reconstructShapeDensityImage(
  spe,
  marks = "cell_category",
  image_col = "image_name",
  image_id = "E04",
  mark_select = "islet",
  bndw = bndw,
  dim = 500,
  thres =  thres
)
```

We can plot both the points and the estimated islets.

```{r, eval=FALSE}
islet <- reconstructShapeDensityImage(
  spe,
  marks = "cell_category",
  image_col = "image_name",
  image_id = "E04",
  mark_select = "islet"
) 
```


<!-- ```{r, eval=FALSE, include=FALSE} -->
<!-- p <- plotSpots(spe[,spe[["patient_id"]] == 6126 & -->
<!--                 spe[["image_name"]] %in% c("E04")], -->
<!--           annotate = "cell_type", -->
<!--           sample_id = "image_name", -->
<!--           in_tissue = NULL, -->
<!--           y_reverse = FALSE) + -->
<!--     geom_sf(data = islet, aes(), fill = NA) -->
<!-- ``` -->


```{r, eval=FALSE}
# Cannot easily add geom_df to plotSpots, therefore custom function here...
spe_sel <- spe[, spe[["image_name"]] %in% c("E04")]
spe_sel_df <- cbind(spatialCoords(spe_sel), colData(spe_sel))

ggplot() +
  geom_point(data = spe_sel_df,
             aes(x = cell_x, y = cell_y, color = cell_category), size = 0.75) +
  theme_light() +
  #scale_color_brewer(palette = "Set1") +
  geom_sf(data = islet, fill = NA, color = "black")
```

## Reconstruction of diabetes islets for all images

```{r, eval=FALSE}
all_islets <- reconstructShapeDensitySPE(spe, marks = "cell_category",
                             image_col = "image_name",
                             mark_select = "islet", 
                             bndw = sigma,
                             thres = 0.0025,
                             ncores = 4)
```


```{r sessionInfo}
sessionInfo()
```

